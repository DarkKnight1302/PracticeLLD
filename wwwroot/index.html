<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PracticeLLD - LLD Question Generator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0b1020; color: #e0e0e0; min-height: 100vh; display: flex; flex-direction: column; }

        /* ---- Sign In ---- */
        .auth-overlay { position: fixed; inset: 0; background: #0b1020; z-index: 200; display: flex; justify-content: center; align-items: center; }
        .auth-card { background: #111827; border: 1px solid #2b3645; border-radius: 14px; padding: 40px 36px; width: 100%; max-width: 400px; text-align: center; }
        .auth-card h1 { color: #e94560; font-size: 1.6rem; margin-bottom: 6px; }
        .auth-card p { color: #8ea2b7; font-size: 0.88rem; margin-bottom: 24px; }
        .auth-card input { width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f8fafc; font-size: 0.95rem; margin-bottom: 14px; outline: none; }
        .auth-card input:focus { border-color: #e94560; }
        .auth-card .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .auth-card .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #e94560; color: #fff; }
        .btn-primary:hover:not(:disabled) { background: #c73652; }
        .auth-msg { margin-top: 12px; font-size: 0.85rem; min-height: 20px; }
        .auth-msg.error { color: #ef4444; }
        .auth-msg.success { color: #22c55e; }
        .otp-group { display: none; }
        .otp-group.visible { display: block; }

        /* ---- Top bar ---- */
        .topbar { background: #111827; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2b3645; }
        .topbar .brand { color: #e94560; font-weight: 700; font-size: 1.15rem; letter-spacing: 0.5px; }
        .topbar .user-info { display: flex; align-items: center; gap: 14px; }
        .topbar .user-email { color: #8ea2b7; font-size: 0.85rem; }
        .btn-logout { background: transparent; border: 1px solid #334155; color: #8ea2b7; padding: 6px 14px; border-radius: 6px; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; }
        .btn-logout:hover { border-color: #e94560; color: #e94560; }

        /* ---- Main content ---- */
        .main { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 30px 20px; }
        .controls { display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 24px; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-group label { font-size: 0.78rem; color: #8ea2b7; text-transform: uppercase; letter-spacing: 0.5px; }
        .control-group select { padding: 10px 14px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e0e0e0; font-size: 0.9rem; cursor: pointer; outline: none; }
        .control-group select:focus { border-color: #e94560; }
        .btn-generate { padding: 10px 22px; border-radius: 8px; border: none; background: #e94560; color: #fff; font-size: 0.92rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn-generate:hover:not(:disabled) { background: #c73652; }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ---- Question card ---- */
        .question-card { background: #111827; border: 1px solid #2b3645; border-radius: 12px; width: 100%; max-width: 780px; overflow: hidden; }
        .question-card .card-header { background: #0f172a; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2b3645; }
        .question-card .card-header h2 { color: #e94560; font-size: 1rem; }
        .btn-copy { background: #1a2a4a; color: #8ea2b7; font-size: 0.78rem; padding: 5px 12px; border-radius: 6px; border: 1px solid #334155; cursor: pointer; transition: all 0.2s; }
        .btn-copy:hover { background: #e94560; color: #fff; border-color: #e94560; }
        .btn-copy:disabled { opacity: 0.35; cursor: not-allowed; }
        .card-body { padding: 20px; }
        .card-body .placeholder { text-align: center; color: #6b7a8d; padding: 50px 20px; font-size: 0.92rem; }
        .question-text { color: #e0e0e0; line-height: 1.7; font-size: 0.95rem; white-space: pre-wrap; }
        .constraints-heading { color: #e94560; font-size: 0.9rem; margin-top: 18px; margin-bottom: 8px; }
        .constraints-list { list-style: none; padding: 0; }
        .constraints-list li { padding: 7px 12px; margin: 4px 0; background: #0f172a; border-radius: 6px; font-size: 0.88rem; color: #c0c8d4; }
        .constraints-list li::before { content: "› "; color: #e94560; font-weight: 700; }
        .requirements-heading { color: #36b5e9; font-size: 0.9rem; margin-top: 18px; margin-bottom: 8px; }
        .requirements-list { list-style: none; padding: 0; }
        .requirements-list li { padding: 7px 12px; margin: 4px 0; background: #0f172a; border-radius: 6px; font-size: 0.88rem; color: #c0c8d4; }
        .requirements-list li::before { content: "✦ "; color: #36b5e9; font-weight: 700; }
        .nfr-heading { color: #e9a545; font-size: 0.9rem; margin-top: 18px; margin-bottom: 8px; }
        .nfr-list { list-style: none; padding: 0; }
        .nfr-list li { padding: 7px 12px; margin: 4px 0; background: #0f172a; border-radius: 6px; font-size: 0.88rem; color: #c0c8d4; }
        .nfr-list li::before { content: "⚙ "; color: #e9a545; font-weight: 700; }
        .short-title { display: inline-block; background: #e94560; color: #fff; padding: 3px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 600; margin-top: 14px; }

        .loading { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 50px 0; color: #8ea2b7; font-size: 0.9rem; }
        .spinner { width: 22px; height: 22px; border: 3px solid #1e293b; border-top-color: #e94560; border-radius: 50%; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-msg { color: #ef4444; text-align: center; padding: 30px 20px; font-size: 0.9rem; }

        .history-list { margin-top: 24px; width: 100%; max-width: 780px; }
        .history-list h3 { color: #8ea2b7; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .history-item { background: #111827; border: 1px solid #2b3645; border-radius: 8px; padding: 14px 18px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s; }
        .history-item:hover { border-color: #e94560; }
        .history-item .hi-title { color: #e0e0e0; font-size: 0.9rem; font-weight: 600; }
        .history-item .hi-meta { color: #6b7a8d; font-size: 0.78rem; margin-top: 4px; }

        @media (max-width: 600px) {
            .controls { flex-direction: column; align-items: stretch; }
            .auth-card { margin: 16px; padding: 28px 20px; }
        }
    </style>
</head>
<body>

<!-- ============ AUTH OVERLAY ============ -->
<div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
        <h1>PracticeLLD</h1>
        <p>Sign in with your email to generate LLD questions</p>

        <div id="emailStep">
            <input type="email" id="emailInput" placeholder="you@example.com" autocomplete="email" />
            <button class="btn btn-primary" id="sendOtpBtn" onclick="sendOtp()">Send OTP</button>
        </div>

        <div class="otp-group" id="otpStep">
            <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6" autocomplete="one-time-code" />
            <button class="btn btn-primary" id="verifyOtpBtn" onclick="verifyOtp()">Verify &amp; Sign In</button>
        </div>

        <div class="auth-msg" id="authMsg"></div>
    </div>
</div>

<!-- ============ MAIN APP ============ -->
<div class="topbar" id="topbar" style="display:none;">
    <span class="brand">PracticeLLD</span>
    <div class="user-info">
        <span class="user-email" id="userEmailLabel"></span>
        <button class="btn-logout" onclick="logout()">Sign Out</button>
    </div>
</div>

<div class="main" id="mainContent" style="display:none;">
    <div class="controls">
        <div class="control-group">
            <label>Difficulty</label>
            <select id="difficulty">
                <option value="Easy">Easy</option>
                <option value="Medium" selected>Medium</option>
                <option value="Hard">Hard</option>
            </select>
        </div>
        <button class="btn-generate" id="generateBtn" onclick="generateQuestion()">Generate Question</button>
    </div>

    <div class="question-card">
        <div class="card-header">
            <h2>LLD Question</h2>
            <button class="btn-copy" id="copyBtn" onclick="copyQuestion()" disabled>&#128203; Copy</button>
        </div>
        <div class="card-body" id="questionBody">
            <div class="placeholder">Choose a difficulty and click <strong>Generate Question</strong> to begin.</div>
        </div>
    </div>

    <div class="history-list" id="historySection" style="display:none;">
        <h3>Previously Asked</h3>
        <div id="historyItems"></div>
    </div>
</div>

<script>
    // ---- State ----
    const STORAGE_AUTH   = 'practicelld_auth_token';
    const STORAGE_EMAIL  = 'practicelld_user_email';
    const STORAGE_HIST   = 'practicelld_question_history';

    let authToken  = localStorage.getItem(STORAGE_AUTH) || '';
    let userEmail  = localStorage.getItem(STORAGE_EMAIL) || '';
    let currentQ   = null;
    let isLoading  = false;

    // ---- Boot ----
    (function init() {
        if (authToken && userEmail) {
            showApp();
        }
    })();

    // ============================
    //  AUTH
    // ============================
    function setAuthMsg(text, isError) {
        const el = document.getElementById('authMsg');
        el.textContent = text;
        el.className = 'auth-msg ' + (isError ? 'error' : 'success');
    }

    async function sendOtp() {
        const email = document.getElementById('emailInput').value.trim();
        if (!email) { setAuthMsg('Please enter your email.', true); return; }

        const btn = document.getElementById('sendOtpBtn');
        btn.disabled = true;
        setAuthMsg('Sending OTP�', false);

        try {
            const res = await fetch('/api/SignIn/send-otp', {
                method: 'POST',
                headers: { 'x-uid': email }
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || 'Failed to send OTP');
            }

            setAuthMsg('OTP sent! Check your email.', false);
            document.getElementById('otpStep').classList.add('visible');
            document.getElementById('otpInput').focus();
        } catch (e) {
            setAuthMsg(e.message, true);
        } finally {
            btn.disabled = false;
        }
    }

    async function verifyOtp() {
        const email = document.getElementById('emailInput').value.trim();
        const otp   = document.getElementById('otpInput').value.trim();
        if (!otp) { setAuthMsg('Please enter the OTP.', true); return; }

        const btn = document.getElementById('verifyOtpBtn');
        btn.disabled = true;
        setAuthMsg('Verifying�', false);

        try {
            const res = await fetch('/api/SignIn/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-uid': email
                },
                body: JSON.stringify({ otp: otp })
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || 'Verification failed');
            }

            const data = await res.json();
            authToken = data.authToken || data.AuthToken;
            userEmail = email;

            localStorage.setItem(STORAGE_AUTH, authToken);
            localStorage.setItem(STORAGE_EMAIL, userEmail);

            showApp();
        } catch (e) {
            setAuthMsg(e.message, true);
        } finally {
            btn.disabled = false;
        }
    }

    function logout() {
        authToken = '';
        userEmail = '';
        localStorage.removeItem(STORAGE_AUTH);
        localStorage.removeItem(STORAGE_EMAIL);
        location.reload();
    }

    function showApp() {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('topbar').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'flex';
        document.getElementById('userEmailLabel').textContent = userEmail;
        renderHistory();
    }

    // ============================
    //  QUESTION GENERATION
    // ============================
    async function generateQuestion() {
        if (isLoading) return;
        isLoading = true;

        const btn = document.getElementById('generateBtn');
        const body = document.getElementById('questionBody');
        btn.disabled = true;
        document.getElementById('copyBtn').disabled = true;
        currentQ = null;

        body.innerHTML = '<div class="loading"><div class="spinner"></div>Generating question�</div>';

        const difficulty = document.getElementById('difficulty').value;
        const history = getHistory();
        const alreadyAsked = history.map(h => h.shortTitle);

        try {
            const res = await fetch('/api/LldQuestion/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken,
                    'x-uid': userEmail,
                    'Audience': 'PracticeLLDClient'
                },
                body: JSON.stringify({
                    difficulty: difficulty,
                    alreadyAskedShortTitles: alreadyAsked
                })
            });

            if (res.status === 401) {
                body.innerHTML = '<div class="error-msg">Session expired. Please sign in again.</div>';
                logout();
                return;
            }

            if (res.status === 429) {
                body.innerHTML = '<div class="error-msg">Daily limit reached (15 questions/day). Try again tomorrow.</div>';
                return;
            }

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || 'Failed to generate question');
            }

            const q = await res.json();
            currentQ = q;

            renderQuestionCard(q);
            document.getElementById('copyBtn').disabled = false;

            // Save to history
            addToHistory({
                shortTitle: q.shortTitle || q.short_title || '',
                question: q.question || '',
                difficulty: difficulty,
                timestamp: new Date().toISOString()
            });
        } catch (e) {
            body.innerHTML = `<div class="error-msg">${escapeHtml(e.message)}</div>`;
        } finally {
            btn.disabled = false;
            isLoading = false;
        }
    }

    function renderQuestionCard(q) {
        const body = document.getElementById('questionBody');
        let html = `<div class="question-text">${escapeHtml(q.question)}</div>`;

        const constraints = q.constraints || [];
        if (constraints.length) {
            html += '<div class="constraints-heading">Constraints</div><ul class="constraints-list">';
            constraints.forEach(c => { html += `<li>${escapeHtml(c)}</li>`; });
            html += '</ul>';
        }

        const funcReqs = q.functional_requirements || [];
        if (funcReqs.length) {
            html += '<div class="requirements-heading">Functional Requirements</div><ul class="requirements-list">';
            funcReqs.forEach(r => { html += `<li>${escapeHtml(r)}</li>`; });
            html += '</ul>';
        }

        const nfReqs = q.non_functional_requirements || [];
        if (nfReqs.length) {
            html += '<div class="nfr-heading">Non-Functional Requirements</div><ul class="nfr-list">';
            nfReqs.forEach(r => { html += `<li>${escapeHtml(r)}</li>`; });
            html += '</ul>';
        }

        const title = q.shortTitle || q.short_title || '';
        if (title) {
            html += `<span class="short-title">${escapeHtml(title)}</span>`;
        }

        body.innerHTML = html;
    }

    function copyQuestion() {
        if (!currentQ) return;
        let text = currentQ.question || '';
        const constraints = currentQ.constraints || [];
        if (constraints.length) {
            text += '\n\nConstraints:\n';
            constraints.forEach(c => { text += `• ${c}\n`; });
        }
        const funcReqs = currentQ.functional_requirements || [];
        if (funcReqs.length) {
            text += '\nFunctional Requirements:\n';
            funcReqs.forEach(r => { text += `✦ ${r}\n`; });
        }
        const nfReqs = currentQ.non_functional_requirements || [];
        if (nfReqs.length) {
            text += '\nNon-Functional Requirements:\n';
            nfReqs.forEach(r => { text += `⚙ ${r}\n`; });
        }
        navigator.clipboard.writeText(text.trim()).then(() => {
            const btn = document.getElementById('copyBtn');
            const orig = btn.innerHTML;
            btn.innerHTML = '&#10003; Copied!';
            setTimeout(() => { btn.innerHTML = orig; }, 1500);
        });
    }

    // ============================
    //  LOCAL HISTORY
    // ============================
    function getHistory() {
        try { return JSON.parse(localStorage.getItem(STORAGE_HIST) || '[]'); }
        catch { return []; }
    }

    function addToHistory(item) {
        const hist = getHistory();
        hist.unshift(item);
        if (hist.length > 50) hist.length = 50;
        localStorage.setItem(STORAGE_HIST, JSON.stringify(hist));
        renderHistory();
    }

    function renderHistory() {
        const hist = getHistory();
        const section = document.getElementById('historySection');
        const container = document.getElementById('historyItems');

        if (!hist.length) { section.style.display = 'none'; return; }

        section.style.display = 'block';
        container.innerHTML = '';

        hist.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="hi-title">${escapeHtml(h.shortTitle || 'Question ' + (i + 1))}</div>
                <div class="hi-meta">${escapeHtml(h.difficulty)} � ${new Date(h.timestamp).toLocaleString()}</div>
            `;
            div.onclick = () => {
                document.getElementById('questionBody').innerHTML =
                    `<div class="question-text">${escapeHtml(h.question)}</div>`;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            container.appendChild(div);
        });
    }

    // ---- Helpers ----
    function escapeHtml(str) {
        if (!str) return '';
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    // Allow Enter key in inputs
    document.getElementById('emailInput').addEventListener('keydown', e => { if (e.key === 'Enter') sendOtp(); });
    document.getElementById('otpInput').addEventListener('keydown', e => { if (e.key === 'Enter') verifyOtp(); });
</script>
</body>
</html>
